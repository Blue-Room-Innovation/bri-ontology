## Waste / MARPOL SHACL Shapes (sin legado DPP)
@prefix rdf:     <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:    <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd:     <http://www.w3.org/2001/XMLSchema#> .
@prefix sh:      <http://www.w3.org/ns/shacl#> .
@prefix dct:     <http://purl.org/dc/terms/> .
@prefix schema:  <http://schema.org/> .
@prefix dwp:     <https://raw.githubusercontent.com/Blue-Room-Innovation/bri-ontology/main/ontology/v0.1/digitalWastePassport.ttl#> .
@prefix unece:   <https://test.uncefact.org/vocabulary/untp/core/0/> .
@prefix unece-dpp: <https://test.uncefact.org/vocabulary/untp/dpp/0/> .

dwp:DigitalWastePassportShape a sh:NodeShape ;
  sh:targetClass dwp:DigitalWastePassport ;
  sh:name "Digital Waste Passport"@es ;
  sh:description "Shape principal del DigitalWastePassport; cerrado para detectar propiedades inesperadas."@es ;
  sh:property [ sh:path dct:issued ; sh:datatype xsd:dateTime ; sh:minCount 1 ; sh:maxCount 1 ; sh:message "Debe tener una fecha de emisión (dct:issued)."@es ] ;
  sh:property [ sh:path dct:publisher ; sh:minCount 1 ; sh:maxCount 1 ; sh:message "Debe indicar publisher (dct:publisher)."@es ] ;
  sh:property [ sh:path dwp:credentialSubject ; sh:minCount 1 ; sh:maxCount 1 ; sh:class dwp:WastePassport ; sh:message "Debe enlazar exactamente un WastePassport."@es ] ;
  sh:property [ sh:path dct:valid ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:dateTime ] ;
  sh:ignoredProperties ( rdf:type ) ;
  sh:closed true .

dwp:WastePassportShape a sh:NodeShape ;
  sh:targetClass dwp:WastePassport ;
  sh:name "Waste Passport"@es ;
  sh:description "Shape del WastePassport cerrado; sólo permite propiedades definidas."@es ;
  sh:property [ sh:path dwp:waste ; sh:minCount 1 ; sh:maxCount 1 ; sh:class dwp:Waste ; sh:message "Debe referenciar un Waste."@es ] ;
  sh:property [ sh:path dct:identifier ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
  sh:property [ sh:path unece:reportingStandard ; sh:minCount 0 ; sh:class unece:Standard ] ;
  sh:ignoredProperties ( rdf:type ) ;
  sh:closed true .

dwp:WasteShape a sh:NodeShape ;
  sh:targetClass dwp:Waste ;
  sh:name "Waste"@es ;
  sh:description "Shape de Waste cerrado con propiedades UNECE permitidas."@es ;
  sh:property [ sh:path unece:name ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ; sh:message "Debe tener nombre (unece:name)."@es ] ;
  sh:property [ sh:path unece:productName ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
  sh:property [ sh:path unece:productDescription ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
  sh:property [ sh:path unece:hasBatchIdentifier ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
  # País de origen restringido a un conjunto permitido (ejemplo de enumeración inicial)
  # País de origen restringido a un conjunto ampliado (sample ISO 3166 Alpha-2)
  # Nota: ampliar dinámicamente leyendo codelist futuro -> script build
  sh:property [ sh:path unece:originCountry ; sh:minCount 0 ; sh:maxCount 1 ;
                sh:in (
                  <https://vocabulary.uncefact.org/CountryId#DE>
                  <https://vocabulary.uncefact.org/CountryId#ES>
                  <https://vocabulary.uncefact.org/CountryId#FR>
                  <https://vocabulary.uncefact.org/CountryId#IT>
                  <https://vocabulary.uncefact.org/CountryId#NL>
                  <https://vocabulary.uncefact.org/CountryId#PT>
                  <https://vocabulary.uncefact.org/CountryId#BE>
                  <https://vocabulary.uncefact.org/CountryId#DK>
                  <https://vocabulary.uncefact.org/CountryId#SE>
                  <https://vocabulary.uncefact.org/CountryId#NO>
                  <https://vocabulary.uncefact.org/CountryId#FI>
                  <https://vocabulary.uncefact.org/CountryId#GB>
                  <https://vocabulary.uncefact.org/CountryId#IE>
                ) ;
                sh:message "originCountry debe estar en el listado permitido (subset EU+GB)."@es ] ;
  sh:property [ sh:path unece:productionDate ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:date ] ;
  sh:property [ sh:path unece:weightQuantity ; sh:minCount 0 ; sh:maxCount 1 ; sh:datatype xsd:decimal ; sh:minExclusive 0 ] ;
  # Unidad declarada restringida (subset de UnitMeasureCode)
  sh:property [ sh:path unece:declaredUnit ; sh:minCount 0 ; sh:maxCount 1 ;
                sh:in (
                  <https://vocabulary.uncefact.org/UnitMeasureCode#KGM>
                  <https://vocabulary.uncefact.org/UnitMeasureCode#TNE>
                  <https://vocabulary.uncefact.org/UnitMeasureCode#LTR>
                  <https://vocabulary.uncefact.org/UnitMeasureCode#MTR>
                  <https://vocabulary.uncefact.org/UnitMeasureCode#CMQ>
                ) ;
                sh:message "declaredUnit debe ser una de: KGM, TNE, LTR, MTR, CMQ."@es ] ;
  sh:property [ sh:path unece:hasConstituent ; sh:minCount 0 ; sh:class unece:MaterialConstituent ] ;
  # Restricción agregada: suma de massFraction <= 1
  sh:sparql [
    sh:message "La suma de massFraction de los constituyentes no debe exceder 1."@es ;
    sh:select """
      SELECT $this
      WHERE {
        OPTIONAL {
          $this unece:hasConstituent ?c .
          ?c unece:massFraction ?mf .
        }
      }
      GROUP BY $this
      HAVING ( SUM(xsd:decimal(?mf)) > 1 )
    """
  ] ;
  sh:ignoredProperties ( rdf:type ) ;
  sh:closed true .

# Constituyentes de materiales
unece:MaterialConstituentShape a sh:NodeShape ;
  sh:targetClass unece:MaterialConstituent ;
  sh:name "Material Constituent"@es ;
  sh:property [ sh:path unece:materialType ; sh:minCount 1 ; sh:maxCount 1 ; sh:nodeKind sh:IRI ] ;
  sh:property [ sh:path unece:massFraction ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:decimal ; sh:minInclusive 0 ; sh:maxInclusive 1 ] ;
  sh:ignoredProperties ( rdf:type ) ;
  sh:closed true .

# Estándar de reporte
unece:StandardShape a sh:NodeShape ;
  sh:targetClass unece:Standard ;
  sh:name "Reporting Standard"@es ;
  sh:property [ sh:path unece:standardName ; sh:minCount 1 ; sh:maxCount 1 ; sh:datatype xsd:string ] ;
  sh:ignoredProperties ( rdf:type ) ;
  sh:closed true .
