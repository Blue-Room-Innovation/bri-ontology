# ADR-005: DerivaciÃ³ automÃ tica de JSON Schema des de SHACL

**Estat:** Proposat  
**Data:** 2026-01-08  
**Ã€mbit:** Digital Product Passport (DPP) â€“ GeneraciÃ³ d'artefactes de validaciÃ³  
**Decisors:** Arquitectura / Data / Plataforma  
**Relacionat amb:** ADR-001

---

## 1. Context

Segons [ADR-001](./01.ADR-001%20SHACL%20com%20a%20font%20de%20veritat%20semÃ ntica%20i%20pipeline%20de%20validaciÃ³%20per%20capes), SHACL Ã©s la font de veritat semÃ ntica del model de dades del Digital Product Passport. A partir d'aquest model s'han de derivar automÃ ticament altres artefactes per a validaciÃ³ estructural, especialment **JSON Schema**.

Aquesta derivaciÃ³ respon a la necessitat de:

* **Validar documents JSON en temps real** (APIs, processos d'ingestiÃ³).
* **Proporcionar contractes estructurals** comprensibles per desenvolupadors que treballen amb JSON/JSON-LD.
* **Mantenir coherÃ¨ncia automÃ tica** entre el model semÃ ntic (SHACL) i la seva projecciÃ³ estructural (JSON Schema).

Tanmateix, **SHACL i JSON Schema sÃ³n tecnologies fonamentalment diferents**:

| Aspecte              | SHACL                                    | JSON Schema                       |
| -------------------- | ---------------------------------------- | --------------------------------- |
| **Paradigma**        | ValidaciÃ³ de grafs RDF                   | ValidaciÃ³ d'estructura JSON       |
| **SemÃ ntica**        | ExpressiÃ³ de significat i relacions      | NomÃ©s forma i tipus de dades      |
| **EquivalÃ¨ncies**    | Diverses estructures JSON â†’ mateix graf  | Una estructura JSON â†’ un esquema  |
| **sh:or / sh:xone**  | Suportades nativament                    | `anyOf`, `oneOf`                  |
| **sh:sparql**        | ValidaciÃ³ amb queries complexes          | No suportades                     |
| **Closed shapes**    | `sh:closed true`                         | `additionalProperties: false`     |
| **Ontologia**        | Necessita raonament sobre `rdfs:domain`  | No tÃ© concepte d'ontologia        |

**Aquesta conversiÃ³ Ã©s sempre parcial i amb pÃ¨rdua de semÃ ntica**. No Ã©s possible expressar tota la riquesa de SHACL en JSON Schema, i intentar-ho seria contraproduent.

---

## 2. DecisiÃ³

S'adopta un **mecanisme automÃ tic de derivaciÃ³ SHACL â†’ JSON Schema** basat en els segÃ¼ents principis:

### 2.1 Objectiu de la derivaciÃ³

JSON Schema generat des de SHACL serveix exclusivament per a:

* âœ… ValidaciÃ³ estructural de documents JSON/JSON-LD
* âœ… GeneraciÃ³ de contractes per a APIs REST
* âœ… IntegraciÃ³ en pipelines CI/CD
* âœ… GeneraciÃ³ de definicions TypeScript

âŒ **NO** serveix per a:

* Capturar semÃ ntica completa del model
* Substituir validaciÃ³ SHACL en contextos RDF
* Expressar lÃ²gica de negoci complexa

### 2.2 Abast de la conversiÃ³

La conversiÃ³ automÃ tica inclou:

| SHACL Constraint            | JSON Schema Equivalent         | Notes                                            |
| --------------------------- | ------------------------------ | ------------------------------------------------ |
| `sh:datatype`               | `type`, `format`               | xsd:string â†’ string, xsd:integer â†’ integer, etc. |
| `sh:minCount`, `sh:maxCount`| `minItems`, `maxItems`         | Arrays (si maxCount > 1)                         |
| `sh:minCount 1`             | `required: [propertyName]`     | Propietat obligatÃ²ria                            |
| `sh:class`                  | `$ref` o `type: object`        | ReferÃ¨ncia a definiciÃ³ d'objecte                 |
| `sh:in`                     | `enum`                         | EnumeraciÃ³ de valors permesos                    |
| `sh:minExclusive`           | `exclusiveMinimum`             | ValidaciÃ³ numÃ¨rica                               |
| `sh:maxExclusive`           | `exclusiveMaximum`             | ValidaciÃ³ numÃ¨rica                               |
| `sh:minInclusive`           | `minimum`                      | ValidaciÃ³ numÃ¨rica                               |
| `sh:maxInclusive`           | `maximum`                      | ValidaciÃ³ numÃ¨rica                               |
| `sh:minLength`, `sh:maxLength` | `minLength`, `maxLength`    | Cadenes de text                                  |
| `sh:pattern`                | `pattern`                      | Expressions regulars                             |
| `sh:closed true`            | `additionalProperties: false`  | NomÃ©s propietats definides                       |
| `sh:or`                     | `anyOf`                        | MÃºltiples opcions vÃ lides                        |
| `sh:xone`                   | `oneOf`                        | Exactament una opciÃ³ vÃ lida                      |
| `sh:and`                    | `allOf`                        | Totes les condicions complides                   |

### 2.3 Exclusions explÃ­cites

Les segÃ¼ents construccions SHACL **NO es converteixen**:

* âŒ `sh:sparql` â€“ LÃ²gica de validaciÃ³ complexa no expressable en JSON Schema
* âŒ `sh:node` â€“ Shapes anidades amb lÃ²gica complexa (nomÃ©s si no es poden mapear directament)
* âŒ `rdfs:domain`, `rdfs:range` â€“ InferÃ¨ncia ontolÃ²gica (no aplicable a JSON)
* âŒ Validacions que depenen de grafs externs o raonament OWL

Quan es trobi una d'aquestes construccions, el script generarÃ  un **warning** i continuarÃ .

### 2.4 Principis de disseny del generador

1. **Deterministicitat**: Donat un fitxer SHACL, sempre genera el mateix JSON Schema.
2. **Auditabilitat**: El JSON Schema generat inclou comentaris indicant la procedÃ¨ncia (`$comment: "Generated from SHACL shape dwp:WasteShape"`).
3. **Immutabilitat**: El JSON Schema **NO s'edita manualment**. Qualsevol canvi s'ha de fer en SHACL i regenerar.
4. **Extensibilitat**: El script permet afegir noves regles de conversiÃ³ sense trencar les existents.

### 2.5 Pipeline d'execuciÃ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SHACL Shapes   â”‚ (Source of Truth)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  shacl-to-      â”‚ (Script Python)
â”‚  jsonschema.py  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JSON Schema    â”‚ (Derivat automÃ tic)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TypeScript     â”‚ (GeneraciÃ³ opcional)
â”‚  Definitions    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

El script s'executa:

* âœ… Manualment quan es modifica un fitxer SHACL
* âœ… AutomÃ ticament en CI/CD abans de validar exemples
* âœ… Com a pre-commit hook (opcional)

---

## 3. MotivaciÃ³

### 3.1 SeparaciÃ³ semÃ ntica vs. estructural

SHACL valida **significat** (grafs RDF), JSON Schema valida **forma** (documents JSON). Aquesta distinciÃ³ Ã©s fonamental:

* Un mateix graf RDF pot ser serialitzat en mÃºltiples formes JSON-LD.
* SHACL no valida la forma del JSON, nomÃ©s el graf resultant.
* JSON Schema no entÃ©n semÃ ntica, nomÃ©s estructura.

Generar JSON Schema des de SHACL permet:

* âœ… Validar documents JSON **abans** de convertir-los a RDF
* âœ… Detectar errors estructurals rÃ pidament (sense invocar un motor SHACL)
* âœ… Utilitzar eines JSON estÃ ndard (ajv, json-schema-validator, etc.)

### 3.2 CoherÃ¨ncia automÃ tica

La generaciÃ³ automÃ tica garanteix que JSON Schema i SHACL no divergeixen:

* âŒ **Problema anterior**: EdiciÃ³ manual de JSON Schema â†’ desincronitzaciÃ³ amb SHACL
* âœ… **SoluciÃ³ actual**: JSON Schema sempre regenerat des de SHACL

AixÃ² elimina ambigÃ¼itats sobre quina Ã©s la versiÃ³ "correcta" del model.

### 3.3 IntegraciÃ³ amb ecosistema JavaScript/TypeScript

Moltes eines de desenvolupament esperen JSON Schema:

* Generadors de tipus TypeScript (json-schema-to-typescript)
* Validadors en temps real (ajv, jsonschema)
* DocumentaciÃ³ d'APIs (OpenAPI/Swagger)

Tenir JSON Schema generat automÃ ticament permet integrar SHACL en aquests fluxos sense duplicar esforÃ§.

---

## 4. ConseqÃ¼Ã¨ncies

### 4.1 Positives

* âœ… **Font de veritat Ãºnica**: SHACL roman com a Ãºnica font de veritat semÃ ntica
* âœ… **CoherÃ¨ncia garantida**: JSON Schema sempre alineat amb SHACL
* âœ… **TransparÃ¨ncia**: La conversiÃ³ Ã©s explÃ­cita i auditable
* âœ… **IntegraciÃ³ senzilla**: JSON Schema pot utilitzar-se amb eines estÃ ndard
* âœ… **Mantenibilitat**: NomÃ©s cal editar SHACL, la resta es regenera

### 4.2 Negatives / Limitacions

* âš ï¸ **PÃ¨rdua de semÃ ntica**: JSON Schema no captura tota la riquesa de SHACL
* âš ï¸ **ValidaciÃ³ incompleta**: Algunes restriccions SHACL no sÃ³n expressables en JSON Schema
* âš ï¸ **DependÃ¨ncia del script**: Cal mantenir el generador actualitzat amb noves construccions SHACL
* âš ï¸ **Possibles false positives**: Un document vÃ lid per JSON Schema pot ser invÃ lid per SHACL

### 4.3 Mitigacions

* ğŸ“‹ Documentar explÃ­citament les limitacions de la conversiÃ³
* ğŸ“‹ Mantenir validaciÃ³ SHACL com a pas posterior per a casos crÃ­tics
* ğŸ“‹ Generar warnings quan es trobin construccions no convertibles
* ğŸ“‹ Incloure tests que verifiquin que exemples vÃ lids per JSON Schema tambÃ© ho sÃ³n per SHACL

---

## 5. Exemples de conversiÃ³

### Exemple 1: Propietat obligatÃ²ria amb tipus

**SHACL:**
```turtle
dwp:WasteShape a sh:NodeShape ;
  sh:property [
    sh:path unece:name ;
    sh:datatype xsd:string ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
  ] .
```

**JSON Schema generat:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "unece:name": {
      "type": "string",
      "$comment": "Generated from sh:property with sh:path unece:name"
    }
  },
  "required": ["unece:name"]
}
```

### Exemple 2: EnumeraciÃ³

**SHACL:**
```turtle
sh:property [
  sh:path unece:declaredUnit ;
  sh:in (
    <https://vocabulary.uncefact.org/UnitMeasureCode#KGM>
    <https://vocabulary.uncefact.org/UnitMeasureCode#TNE>
  )
] .
```

**JSON Schema generat:**
```json
{
  "properties": {
    "unece:declaredUnit": {
      "type": "string",
      "enum": [
        "https://vocabulary.uncefact.org/UnitMeasureCode#KGM",
        "https://vocabulary.uncefact.org/UnitMeasureCode#TNE"
      ]
    }
  }
}
```

### Exemple 3: Closed shape

**SHACL:**
```turtle
dwp:WasteShape a sh:NodeShape ;
  sh:closed true ;
  sh:ignoredProperties ( rdf:type ) .
```

**JSON Schema generat:**
```json
{
  "type": "object",
  "additionalProperties": false
}
```

---

## 6. ImplementaciÃ³

### 6.1 Script: `shacl-to-jsonschema.py`

UbicaciÃ³: `scripts/shacl-to-jsonschema.py`

ExecuciÃ³:
```bash
python scripts/shacl-to-jsonschema.py \
  --input shapes/digitalWastePassportShapes.ttl \
  --output build/digitalWastePassport.schema.json
```

### 6.2 DependÃ¨ncies

```
rdflib>=7.0.0
pyshacl>=0.25.0
```

### 6.3 IntegraciÃ³ en CI/CD

Afegir al pipeline:

```yaml
- name: Generate JSON Schema
  run: |
    python scripts/shacl-to-jsonschema.py --input shapes/digitalWastePassportShapes.ttl --output build/digitalWastePassport.schema.json
    python scripts/shacl-to-jsonschema.py --input shapes/digitalMarpolWastePassportShapes.ttl --output build/digitalMarpolWastePassport.schema.json
```

---

## 7. Alternatives considerades

### 7.1 EdiciÃ³ manual de JSON Schema

* âŒ **Rebutjat**: Provoca divergÃ¨ncies entre SHACL i JSON Schema
* âŒ Requereix sincronitzaciÃ³ manual
* âŒ Sense traÃ§abilitat

### 7.2 Ãšs exclusiu de SHACL

* âŒ **Rebutjat**: No permet validaciÃ³ estructural de JSON sense conversiÃ³ a RDF
* âŒ No integrable amb ecosistema JavaScript/TypeScript
* âŒ Rendiment inferior per a validaciÃ³ de documents JSON simples

### 7.3 Definir JSON Schema com a font de veritat

* âŒ **Rebutjat**: Perd semÃ ntica i interoperabilitat
* âŒ Contrari a la decisiÃ³ de l'ADR-001
* âŒ No permet expressar relacions complexes

### 7.4 ConversiÃ³ bidireccional SHACL â†” JSON Schema

* âŒ **Rebutjat**: JSON Schema no tÃ© prou expressivitat per preservar semÃ ntica SHACL
* âŒ Complexitat innecessÃ ria
* âŒ Risc de pÃ¨rdua d'informaciÃ³ en cicles de conversiÃ³

---

## 8. ReferÃ¨ncies

* [ADR-001: SHACL com a font de veritat semÃ ntica](./01.ADR-001%20SHACL%20com%20a%20font%20de%20veritat%20semÃ ntica%20i%20pipeline%20de%20validaciÃ³%20per%20capes)
* [SHACL Specification (W3C)](https://www.w3.org/TR/shacl/)
* [JSON Schema Specification](https://json-schema.org/)
* [RDFLib Documentation](https://rdflib.readthedocs.io/)

---

## 9. Notes de revisiÃ³

* **2026-01-08**: Proposta inicial (ADR-005)
* Pendent aprovaciÃ³ per Arquitectura / Data / Plataforma
* Pendent implementaciÃ³ del script `shacl-to-jsonschema.py`
