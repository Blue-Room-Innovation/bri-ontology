# ADR-004: Estratègia de validació SHACL en processos de governança i certificació

**Estat:** A confirmar
**Data:** 2026-01-08
**Àmbit:** Digital Product Passport (DPP) – Validació semàntica i governança
**Decisors:** Arquitectura / Data Governance / Compliance

---

## 1. Context

El DPP adopta una arquitectura de validació per capes on:

* SHACL és la font de veritat semàntica del model,
* JSON Schema valida estructuralment els documents,
* TypeScript garanteix coherència en desenvolupament.

Tot i això, la validació SHACL presenta característiques que la fan inadequada com a mecanisme de validació contínua en runtime:

* opera sobre grafs RDF complets,
* pot implicar càlculs costosos,
* i no està orientada a contractes d’API o payloads parcials.

Al mateix temps, **no executar SHACL en cap punt** anul·laria el seu valor com a font de veritat semàntica.

Aquest ADR defineix **quan, com i amb quin objectiu** s’ha d’executar la validació SHACL dins del DPP.

---

## 2. Decisió

La validació SHACL s’adopta com a **mecanisme de validació semàntica obligatori en processos de governança**, però **no com a validació contínua en runtime**.

En concret:

* SHACL **no s’executa en cada request d’API**.
* SHACL **sí s’executa en processos de control, certificació i interoperabilitat**.
* SHACL és l’autoritat final sobre la conformitat semàntica del DPP.

---

## 3. Àmbits d’execució de SHACL

### 3.1 Governança del model

SHACL s’ha d’executar obligatòriament en:

* validació de datasets complets,
* verificació de conjunts de dades abans de publicació oficial,
* processos interns de governança del dataspace.

Això garanteix que:

* les dades compleixen el significat del DPP,
* no només la seva estructura.

---

### 3.2 Certificació i compliance

Quan el DPP estigui subjecte a:

* processos de certificació,
* auditories externes,
* requisits normatius,

la validació SHACL constitueix el **mecanisme formal de conformitat semàntica**.

Cap validació estructural pot substituir aquest procés.

---

### 3.3 Interoperabilitat amb tercers

En integracions amb:

* altres dataspaces,
* entitats externes,
* sistemes RDF-first,

la validació SHACL:

* assegura compatibilitat semàntica,
* detecta inconsistències conceptuals,
* permet comparabilitat entre datasets.

---

## 4. Relació amb JSON Schema

### 4.1 Complementarietat, no substitució

JSON Schema i SHACL tenen rols clarament diferenciats:

| Aspecte          | JSON Schema | SHACL |
| ---------------- | ----------- | ----- |
| Valida documents | Sí          | No    |
| Valida grafs RDF | No          | Sí    |
| Ús en runtime    | Sí          | No    |
| Ús en governança | No          | Sí    |
| Semàntica rica   | No          | Sí    |

Aquesta separació és intencional i no accidental.

---

### 4.2 Flux recomanat

En processos de governança:

1. Validació estructural (JSON Schema)
2. Conversió a RDF / JSON-LD
3. Validació semàntica (SHACL)

Això evita executar SHACL sobre dades evidentment mal formades.

---

## 5. Motivació

### 5.1 Eficiència operativa

Executar SHACL en runtime:

* incrementaria la latència,
* afegiria complexitat,
* sense aportar valor proporcional.

Aquest ADR evita aquest sobrecost.

---

### 5.2 Rigor semàntic on cal

En canvi, en processos de:

* certificació,
* publicació oficial,
* interoperabilitat,

la semàntica **sí és crítica**.

Aquest ADR garanteix que SHACL s’executa exactament on aporta valor.

---

### 5.3 Claredat conceptual

Defineix explícitament que:

* passar JSON Schema **no implica** complir el DPP semànticament,
* només SHACL pot certificar conformitat semàntica.

Això evita interpretacions errònies.

---

## 6. Alternatives considerades

### 6.1 SHACL en runtime per totes les dades

**Descartada** perquè:

* és costosa,
* no escala,
* no millora la qualitat operativa de les APIs.

---

### 6.2 SHACL només com a documentació

**Descartada** perquè:

* anul·la el valor normatiu del model,
* converteix SHACL en orientatiu,
* trenca la noció de source of truth.

---

### 6.3 No executar mai SHACL

**Descartada** perquè:

* invalida tota l’arquitectura semàntica,
* redueix el DPP a un simple model estructural.

---

## 7. Conseqüències

### 7.1 Positives

* Validació semàntica rigorosa on és necessària.
* Millor rendiment en runtime.
* Separació clara de responsabilitats.
* Base sòlida per certificacions futures.
* Coherència amb l’arquitectura per capes.

---

### 7.2 Costos i limitacions

* Necessitat d’infraestructura RDF per validació.
* Execució menys freqüent però més pesada.
* Requereix processos de governança definits.

Aquests costos són considerats assumibles i justificats.

---

## 8. Estat final

La validació SHACL es declara **obligatòria en processos de governança, interoperabilitat i certificació**, i **no obligatòria en runtime**.

Qualsevol canvi a aquesta estratègia haurà de:

* justificar-se explícitament,
* documentar-se,
* i formalitzar-se mitjançant un ADR que modifiqui aquest.
