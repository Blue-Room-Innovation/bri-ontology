# ADR-002: Validació estructural obligatòria en CI/CD i en temps d’ingestió

**Estat:** A confirmar
**Data:** 2026-01-08
**Àmbit:** Digital Product Passport (DPP) – Qualitat de dades i pipeline tècnic
**Decisors:** Arquitectura / Plataforma / Data

---

## 1. Context

El pipeline del DPP defineix una separació clara entre:

* validació semàntica (SHACL),
* validació estructural (JSON Schema),
* i contractes de desenvolupament (TypeScript).

Tot i aquesta separació, sense punts de validació **obligatoris**, el sistema continua sent vulnerable a:

* dades mal formades,
* payloads incomplets,
* divergències entre codi i model,
* errors detectats massa tard en el flux.

En projectes de dataspace, els errors estructurals:

* propaguen ràpidament,
* són difícils de depurar,
* i erosionen la confiança entre participants.

Per aquest motiu, la validació estructural no pot ser opcional ni delegada a la bona pràctica individual.

---

## 2. Decisió

S’estableix que la **validació estructural basada en JSON Schema** és:

* **obligatòria** en el pipeline CI/CD,
* **obligatòria** abans de persistir o publicar qualsevol instància del DPP,
* **no opcional** en cap flux operatiu.

Aquesta validació s’aplica a qualsevol instància serialitzada com a JSON (incloent JSON-LD).

---

## 3. Àmbit de la validació

### 3.1 En CI/CD

La validació estructural s’executa com a pas obligatori en:

* pipelines d’integració contínua,
* validació de tests d’integració,
* verificació de fixtures i exemples.

Qualsevol error de validació:

* bloqueja el pipeline,
* impedeix el desplegament,
* ha de ser corregit abans de continuar.

---

### 3.2 En runtime / ingestió

Abans de:

* persistir dades,
* publicar-les al dataspace,
* exposar-les via API,

les instàncies del DPP han de passar la validació JSON Schema.

Si la validació falla:

* la instància es rebutja,
* es retorna un error estructurat,
* no entra al sistema.

---

## 4. Relació amb la validació semàntica (SHACL)

### 4.1 No substitució

Aquesta decisió **no substitueix** la validació semàntica amb SHACL.

* JSON Schema valida **forma**.
* SHACL valida **significat**.

Són complementàries i no intercanviables.

---

### 4.2 Moment d’execució de SHACL

La validació SHACL:

* no és obligatòria en cada request,
* però ha d’executar-se en:

  * processos de governança,
  * integracions amb tercers,
  * validació de datasets complets,
  * auditories i certificacions.

Aquesta separació respon a criteris de cost, rendiment i necessitat real.

---

## 5. Motivació

### 5.1 Prevenció primerenca d’errors

Validar estructuralment en punts primerencs permet:

* detectar errors abans que entrin al sistema,
* reduir costos de correcció,
* millorar la qualitat global de les dades.

---

### 5.2 Contractes clars i exigibles

La validació obligatòria converteix:

* els esquemes,
* els tipus,
* i el pipeline

en **contractes reals**, no recomanacions.

---

### 5.3 Confiança entre sistemes

En un ecosistema de dataspace, la confiança no és implícita:

* es construeix mitjançant garanties tècniques,
* i la validació estructural és una d’elles.

---

## 6. Alternatives considerades

### 6.1 Validació opcional

**Descartada** perquè:

* depèn de la disciplina individual,
* introdueix inconsistència,
* genera dades defectuoses en producció.

---

### 6.2 Validació només en runtime

**Descartada** perquè:

* detecta errors massa tard,
* trenca pipelines ja desplegats,
* augmenta el cost operatiu.

---

### 6.3 Validació només en CI/CD

**Descartada** perquè:

* no cobreix ingestió externa,
* no protegeix APIs públiques,
* deixa oberta la porta a dades invàlides.

---

## 7. Conseqüències

### 7.1 Positives

* Millora significativa de la qualitat de dades.
* Errors detectats abans de producció.
* Menor càrrega de depuració.
* Contractes d’API clars i enforceables.
* Major confiança en el dataspace.

---

### 7.2 Costos i limitacions

* Increment del temps de pipeline.
* Necessitat de mantenir esquemes sincronitzats.
* Gestió d’errors de validació més rigorosa.

Aquests costos són considerats acceptables en relació amb els beneficis.

---

## 8. Estat final

La validació estructural obligatòria es declara **part essencial del pipeline del DPP**.
Qualsevol excepció haurà de:

* ser explícita,
* estar justificada,
* i quedar documentada mitjançant un ADR específic.


